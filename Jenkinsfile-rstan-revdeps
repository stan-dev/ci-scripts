#!/usr/bin/env groovy

@Library('StanUtils')
import org.stan.Utils

utils = new org.stan.Utils()

pipeline {
    agent none
    options {
        preserveStashes(buildCount: 7)
    }
    parameters {
        string(defaultValue: 'develop', name: 'rstan_branch',
               description: 'RStan branch to test against.')
        string(defaultValue: 'develop', name: 'stan_pr',
               description: 'Stan PR to test against. Will check out this PR in the downstream Stan repo.')
        string(defaultValue: 'nightly', name: 'stanc3_version',
               description: 'Stanc3 PR to test against. Will check out this PR in the downstream Math repo.')
    }
    environment {
        TIMEOUT = 40
        PARALLEL = 4
        CRANCACHE_DISABLE = 1
    }
    stages {
        stage('RStan revdeps') {
            agent {
                dockerfile {
                    filename 'docker/rstan-revdeps/Dockerfile'
                    dir '.'
                    label 'linux'
                }
            }
            steps {
                script {
                    sh "git clone --recursive --depth 1 --shallow-submodules https://github.com/stan-dev/rstan --branch ${params.rstan_branch}"
                    utils.checkout_pr('stan', 'rstan/StanHeaders/inst/include/upstream', params.stan_pr)
                    sh "cd rstan/StanHeaders/inst/ && wget https://github.com/stan-dev/stanc3/releases/download/${params.stanc3_version}/stanc.js"
                    // copied from rstan/sh_b.sh
                    sh """
                    cd rstan
                    rm -Rf StanHeaders/inst/include/src \
                        StanHeaders/inst/include/mathlib \
                        StanHeaders/inst/include/stan \
                        StanHeaders/inst/include/libsundials || true

                    cp -Rf StanHeaders/inst/include/upstream/src StanHeaders/inst/include/src || true
                    cp -Rf StanHeaders/inst/include/upstream/lib/stan_math StanHeaders/inst/include/mathlib || true
                    cp -Rf StanHeaders/inst/include/upstream/lib/stan_math/stan StanHeaders/inst/include/stan || true
                    cp -Rf StanHeaders/inst/include/upstream/lib/stan_math/lib/sundials_* StanHeaders/inst/include/libsundials || true
                    cp -Rf StanHeaders/inst/include/upstream/lib/stan_math/lib/sundials_*/include/* StanHeaders/inst/include/ || true
                    cp -Rf StanHeaders/inst/include/upstream/lib/stan_math/lib/sundials_*/src/* StanHeaders/src/ || true
                    R CMD build "\$@" StanHeaders/ --no-manual --no-build-vignettes
                    """


                    sh """
                    cd rstan
                    ls
                    stanheadtargz=`find StanHeaders*.tar.gz | sort | tail -n 1`
                    Rscript -e 'library(revdepcheck); revdep_check(pkg="$stanheadtargz",num_workers=${env.PARALLEL}, quiet=FALSE, timeout=as.difftime(${env.TIMEOUT}, unit="mins")); revdep_report()'
                    """
                }
            }
            post {
                always {
                    archiveArtifacts 'rstan/StanHeaders/revdep/*.md'
                    retry(3) { deleteDir() }
                }
            }
        }
    }
    post {
        always {
            node('linux') {
                recordIssues enabledForFailure: false, tool: clang()
            }
        }
        success { script { utils.mailBuildResults('SUCCESSFUL') } }
        unstable { script { utils.mailBuildResults('UNSTABLE') } }
        failure { script { utils.mailBuildResults('FAILURE') } }
    }
}
