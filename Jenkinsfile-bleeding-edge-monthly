#!/usr/bin/env groovy
@Library('StanUtils')
import org.stan.Utils

// How do we pass 
def runTests(String testPath, boolean jumbo = false) {
    try {
        sh "python3 runTests.py -j${env.PARALLEL} ${testPath}"
    }
    finally { junit 'test/**/*.xml' }
}

def setupMakeLocal() {
    // When ready, change O=3
    sh """
        echo O=0 >> make/local
        echo CC="clang" >> make/local
        echo CXX="clang++" >> make/local
        echo CFLAGS="-stdlib=libc++" >> make/local
        echo CPPFLAGS="-nostdinc++ -nodefaultlibs -I/usr/local/include/c++/v1 -L/usr/local/lib -Wl,-rpath,/usr/local/lib -lc++ -lc++abi -lm -lc -lgcc_s -lgcc" >> make/local
        echo CXXFLAGS="-fsanitize=address -nostdinc++ -nostdlib++ -I/usr/local/include/c++/v1 -L/usr/local/lib -Wl,-rpath,/usr/local/lib -lc++" >> make/local
        echo LDFLAGS="-L/usr/local/lib -Wl,-R/usr/local/lib -I/usr/local/include/c++/v1" >> make/local

        cat make/local
    """
}

def utils = new org.stan.Utils()

pipeline {
    agent none
    options {
        skipDefaultCheckout()
        preserveStashes(buildCount: 7)
        parallelsAlwaysFailFast()
    }
    parameters {
        booleanParam(defaultValue: false, name: 'buildDocker', description: 'Build docker image with latest gcc, clang')
        string(defaultValue: 'develop', name: 'mathBranch', description: 'What match branch to clone')
    }
    environment {
        STAN_NUM_THREADS = 4
        N_TESTS = 100
        PARALLEL = 1 // Change to 4 when ready
        GCC = 'g++'
    }
    stages {
        stage('Build and push docker image') {
            when {
                beforeAgent true
                expression {
                    params.buildDocker
                }
            }
            agent {
                docker {
                    image 'stanorg/stanc3:staticfi'
                    label 'linux'
                    args "--group-add=987 --group-add=988 --entrypoint=\'\' -v /var/run/docker.sock:/var/run/docker.sock"
                }
            }
            environment { DOCKER_TOKEN = credentials('aada4f7b-baa9-49cf-ac97-5490620fce8a') }
            steps {
                script {
                    retry(3) { checkout scm }
                    sh """
                        cd docker/bleeding-edge-compilers
                        docker build -t stanorg/ci:bleeding-edge-compilers --build-arg PUID=990 --build-arg PGID=986 .
                        docker login --username stanorg --password "${DOCKER_TOKEN}"
                        docker push stanorg/ci:bleeding-edge-compilers
                    """

                }
            }
            post {
                always {
                    deleteDir()
                }
            }
        }


        stage('Prepare math') {
            agent {
                docker {
                    image 'alpine/git'
                    label 'linux'
                    args "--entrypoint=\'\'"
                }
            }
            steps {
                script {
                    sh """
                        rm -rf math
                        git clone https://github.com/stan-dev/math.git
                        cd math
                        git checkout ${params.mathBranch}
                        git clean -xffd
                    """
                    stash 'MathSetup'
                }
            }
            post {
                always {
                    deleteDir()
                }
            }
        }

        stage('Full Unit Tests') {
            failFast true
            parallel {
                stage('Run changed unit tests') {
                    agent {
                        docker {
                            image 'stanorg/ci:bleeding-edge-compilers'
                            label 'linux'
                            args '--cap-add SYS_PTRACE'
                        }
                    }
                    steps {
                        unstash 'MathSetup'
                        dir('math') {
                            script{ setupMakeLocal() }
                            sh "python3 runTests.py -j${PARALLEL} --changed --debug"
                        }

                    }
                    post { always { retry(3) { deleteDir() } } }
                }
                stage('Rev/Fwd Unit Tests') {
                    agent {
                        docker {
                            image 'stanorg/ci:bleeding-edge-compilers'
                            label 'linux'
                            args '--cap-add SYS_PTRACE'
                        }
                    }
                    steps {
                        unstash 'MathSetup'
                        dir('math') {
                            script {
                                setupMakeLocal()
                                runTests("test/unit/math/rev")
                                runTests("test/unit/math/fwd")
                            }
                        }

                    }
                    post { always { retry(3) { deleteDir() } } }
                }
                stage('Mix Unit Tests') {
                    agent {
                        docker {
                            image 'stanorg/ci:bleeding-edge-compilers'
                            label 'linux'
                            args '--cap-add SYS_PTRACE'
                        }
                    }
                    steps {
                        unstash 'MathSetup'
                        dir('math') {
                            script {
                                setupMakeLocal()
                                runTests("test/unit/math/mix", true)
                            }
                        }

                    }
                    post { always { retry(3) { deleteDir() } } }
                }
                stage('Prim Unit Tests') {
                    agent {
                        docker {
                            image 'stanorg/ci:bleeding-edge-compilers'
                            label 'linux'
                            args '--cap-add SYS_PTRACE'
                        }
                    }
                    steps {
                        unstash 'MathSetup'
                        dir('math') {
                            script {
                                setupMakeLocal()
                                runTests("test/unit/*_test.cpp", false)
                                runTests("test/unit/math/*_test.cpp", false)
                                runTests("test/unit/math/prim", true)
                                runTests("test/unit/math/memory", false)
                            }
                        }

                    }
                    post { always { retry(3) { deleteDir() } } }
                }
            }
        }

    }

    post {
        always {
            node("linux") {
                recordIssues enabledForFailure: false, tool: clang()
            }
        }
        // success { script { utils.mailBuildResults("SUCCESSFUL") } }
        // unstable { script { utils.mailBuildResults("UNSTABLE") } }
        // failure { script { utils.mailBuildResults("FAILURE") } }
    }
}
